# Frontend Architecture & Implementation Suggestions for Admissions CRM

## 1. Technology Stack Recommendations

To build a robust, scalable, and "vibe coding" friendly frontend that matches your backend's capabilities, I recommend the following stack:

*   **Framework**: **Next.js 14+ (App Router)** - For server-side rendering, SEO (important for public lead forms), and robust routing.
*   **Language**: **TypeScript** - Essential for type safety, especially with the complex data models (Leads, Campaigns, Budgets) defined in your backend.
*   **Styling**: **Tailwind CSS** + **Shadcn UI** - For rapid, beautiful, and accessible UI development. Shadcn provides copy-paste components that are highly customizable.
*   **State Management**: **Zustand** - Lightweight and easier to manage than Redux for global state (User Auth, Sidebar state).
*   **Data Fetching**: **TanStack Query (React Query)** - Critical for managing server state, caching, and background updates (e.g., live call monitoring).
*   **Forms**: **React Hook Form** + **Zod** - For efficient form handling and validation that mirrors your backend Joi schemas.
*   **Icons**: **Lucide React** - Clean, modern icons.

---

## 2. Project Structure (Next.js App Router)

```
/app
  /(auth)
    /login/page.tsx          # Login Screen
    /register/page.tsx       # (Optional) Register Screen
  /(dashboard)               # Protected Layout with Sidebar/Header
    /layout.tsx              # Auth Check & Sidebar Provider
    /page.tsx                # Main Dashboard (Widgets based on Role)
    /leads/
      /page.tsx              # Leads Kanban/List View
      /[id]/page.tsx         # Lead Details & History
    /campaigns/
      /page.tsx              # Campaign List & Status Toggle
      /create/page.tsx       # Multi-step Campaign Wizard
      /[id]/page.tsx         # Campaign Details & Asset Manager
    /budgets/
      /page.tsx              # Budget Requests & Approvals
    /accounting/
      /page.tsx              # Payment Records & Ad Spends
    /telephony/
      /page.tsx              # Smartflo Dialer & Live Calls
    /users/
      /page.tsx              # Admin User Management
  /submit-lead/page.tsx      # Public Lead Submission Form (No Auth)
      # Note: The API response includes the assigned agent details (data.assigned_user).
      # Display a success message like: "Thank you! [Agent Name] will connect with you shortly."
/components
  /ui                        # Shadcn UI Components
  /forms                     # Reusable Form Components
  /tables                    # Data Tables (TanStack Table)
  /telephony                 # Dialer & Call Controls
/lib
  /api.ts                    # Axios Instance with Interceptors (Auth/Refresh)
  /utils.ts                  # Helper functions (Date formatting)
/hooks                       # Custom Hooks (useAuth, useLeads, useSmartflo)
```

---

## 3. Authentication Flow

1.  **Login**:
    *   **UI**: Email & Password fields.
    *   **Action**: POST `/api/v1/auth/login`
    *   **Handling**: Store `accessToken` in memory/Zustand. The `refreshToken` is automatically handled via HTTP-Only cookie.
    *   **Redirect**: To `/dashboard` upon success.

2.  **Token Refresh (Axios Interceptor)**:
    *   On 401 response, interceptor calls POST `/api/v1/auth/refresh`.
    *   If success, retry original request with new token.
    *   If fail, redirect to `/login`.

3.  **Role-Based Protection**:
    *   Create a `RoleGuard` component or Higher-Order Component (HOC) to wrap pages.
    *   Check `user.role` against required permissions before rendering.

---

## 4. Detailed Page & Feature Breakdown by Role

### A. Dashboard (`/`)
*   **Super Admin**: System health, User stats, Total Revenue/Spend.
*   **Marketing Manager**: Active Campaigns, Budget Usage, Lead Generation Stats.
*   **Admission Manager**: Live Call Status, Lead Pipeline Summary, Agent Performance.
*   **Finance**: Pending Budget Approvals, Recent Transactions.

### B. Leads Module (`/leads`)
*   **View**:
    *   **Kanban Board**: Columns for statuses (New, Contacted, Interested, Enrolled).
    *   **Data Table**: Sortable/Filterable list.
*   **Features**:
    *   **Click-to-Call**: Button next to phone number. Triggers POST `/api/v1/smartflo/click-to-call`.
    *   **Filters**: By Source, Status, Assigned Agent.
*   **Permissions**:
    *   `Admission Manager`: View All.
    *   `Admission Executive`: View Assigned Only.

### C. Campaigns Module (`/campaigns`)
*   **UI**: Grid view of campaigns with status badges (Draft, Active, Completed).
*   **Actions**:
    *   **Create**: Form for Name, Date Range, Budget, Platform. (POST `/api/v1/campaigns`)
    *   **Status Toggle**: Switch to Activate/Pause. (PATCH `/api/v1/campaigns/:id/status`)
    *   **Asset Manager**: Upload creatives. (POST `/api/v1/assets`)
*   **Permissions**: `Marketing Manager` (Full Access), `Designer` (Upload Assets).

### D. Budgets & Approvals (`/budgets`)
*   **UI**: Split view - "My Requests" vs "Pending Approvals".
*   **Workflow**:
    1.  **Marketing** creates request (POST `/api/v1/budgets`).
    2.  **Finance** sees request in "Pending" list.
    3.  **Finance** clicks Approve/Reject (PATCH `/api/v1/budgets/:id/approve`).
    4.  **Marketing** uploads Proof (POST `/api/v1/proofs`).
    5.  **Finance** verifies Proof (PATCH `/api/v1/proofs/:id/verify`).

### E. Accounting (`/accounting`)
*   **Tabs**:
    1.  **Payment Records**: Table of all incoming payments. (GET/POST `/api/v1/accounting/payments`)
    2.  **Ad Spends**: Tracker for daily ad spend per platform. (GET/POST `/api/v1/accounting/ad-spends`)
*   **Permissions**: `Finance` (Payments), `Marketing Manager` (Ad Spends).

### F. Telephony / Smartflo (`/telephony`)
*   **Live Monitor & Controls**:
    *   List of active calls.
    *   **Actions**: Listen (Monitor), Whisper (Coach), Barge (Join), Hangup.
    *   **API**: GET `/api/v1/smartflo/live-calls`, POST `/api/v1/smartflo/call-operation`, POST `/api/v1/smartflo/hangup`.
    *   **Access**: Admin, Admission Manager, Admission Executive.
*   **Call History**:
    *   Table of past calls with Recording playback.
    *   **API**: GET `/api/v1/smartflo/call-records`.

---

## 5. API Integration Reference
| **Budgets** | Request Budget | `POST` | `/api/v1/budgets` | Marketing Manager |
| | Approve Budget | `PATCH` | `/api/v1/budgets/:id/approve` | Finance |
| | Upload Proof | `POST` | `/api/v1/proofs` | Auth User |
| | Verify Proof | `PATCH` | `/api/v1/proofs/:id/verify` | Finance |
| | Public Submit | `POST` | `/api/v1/leads/submit` | Public | *Returns `assigned_user` details & `lead_id`* |
| | Create Lead | `POST` | `/api/v1/leads` | Auth User |
| | | | | *Returns `lead_reference_id` (e.g., egsp-admission-20251212-123456)* |
| | List Leads | `GET` | `/api/v1/leads?startDate=...&endDate=...` | Auth User (Scoped) |
| | Initiate Call | `POST` | `/api/v1/leads/:id/call` | Admin/Manager/Exec |
| | Add Note | `POST` | `/api/v1/leads/:id/notes` | Auth User |
| | Transfer Lead | `POST` | `/api/v1/leads/:id/transfer` | Admin/Manager |
| | Update Status | `PATCH` | `/api/v1/leads/:id/status` | Auth User |
| | Get Notes | `GET` | `/api/v1/leads/:id/notes` | Auth User |
| | Delete Lead | `DELETE` | `/api/v1/leads/:id` | Admin (Hard), User (Soft) |
| | Full Update | `PUT` | `/api/v1/leads/:id` | Auth User |
| | Check Existence | `HEAD` | `/api/v1/leads/:id` | Auth User |
| | Allowed Methods | `OPTIONS` | `/api/v1/leads` | Public |
| **Accounting** | Add Payment | `POST` | `/api/v1/accounting/payments` | Finance |
| | Add Ad Spend | `POST` | `/api/v1/accounting/ad-spends` | Marketing Manager |
| | Add Ad Spend | `POST` | `/api/v1/accounting/ad-spends` | Marketing Manager |
| **Smartflo** | Click-to-Call | `POST` | `/api/v1/leads/:id/call` | Admin/Manager/Exec |
| | | | | *Note: `agent_number` is optional if set in User Profile.* |
| | Webhook | `POST` | `/api/v1/smartflo/webhook` | External (Public) |
| | Live Calls | `GET` | `/api/v1/smartflo/live-calls` | Admin/Manager/Exec |
| | Call Records | `GET` | `/api/v1/smartflo/call-records` | Auth User (Scoped) |
| | Monitor/Barge | `POST` | `/api/v1/smartflo/call-operation` | Admin/Manager/Exec |
| | Hangup Call | `POST` | `/api/v1/smartflo/hangup` | Admin/Manager/Exec |
| **Admin Controls** | Update User | `PUT` | `/api/v1/users/:id` | Super Admin |
| | Delete User | `DELETE` | `/api/v1/users/:id` | Super Admin | *Query `?type=hard` for permanent delete* |
| | Delete Campaign | `DELETE` | `/api/v1/campaigns/:id` | Super Admin | *Query `?type=hard` for permanent delete* |
| | Delete Budget | `DELETE` | `/api/v1/budgets/:id` | Super Admin | *Query `?type=soft` or `hard`* |
| | Delete Asset | `DELETE` | `/api/v1/assets/:id` | Super Admin | *Query `?type=soft` or `hard`* |

### G. User Management Updates (`/users`)
*   **Create/Edit User Form**:
    *   Add fields for **Smartflo Agent Number** (e.g., `12345`) and **Caller ID** (DID).
    *   These are crucial for the "Click-to-Call" feature to work seamlessly without manual input every time.
*   **Admin Capabilities**:
    *   **User Edit**: Update name, role, status, and assignment weightage.
    *   **User Delete**: Provide generic "Delete" button (Soft Delete) and "Delete Permanently" (Hard Delete - restricted to Super Admin).
| **Analytics** | Admin Stats | `GET` | `/api/v1/analytics/admin` | Super Admin |
| | Marketing Stats | `GET` | `/api/v1/analytics/marketing` | Marketing Manager |
| | Admission Stats | `GET` | `/api/v1/analytics/admission` | Admission Manager |
| | Finance Stats | `GET` | `/api/v1/analytics/finance` | Finance |
| | Executive Stats | `GET` | `/api/v1/analytics/executive` | Admission Executive |
| **Search** | Global Search | `GET` | `/api/v1/search?q=...` | Auth User (Scoped) |


### H. User Localization & Settings
*   **Profile Settings Page**:
    *   **Preferences Form**: Dropdowns for:
        *   **Currency**: `INR`, `USD`, `EUR` (Default `INR`)
        *   **Language**: `en`, `es`, `fr` (Default `en`)
        *   **Timezone**: `Asia/Kolkata` (Default), Auto-detect from browser.
        *   **Theme**: Light / Dark / System.
    *   **Action**: `PUT /api/v1/users/auth/settings` with payload `{ preferences: { ... } }`.
    *   **Storage**: Save these in local storage on login (`user.preferences`) to apply theme/currency globally.

### I. API Response & Pagination Standard (Updated)
*   **Standard Response Envelope**:
    ```json
    {
      "success": true,
      "message": "Operation successful",
      "data": { ... }, // Main Payload
      "meta": {        // Metadata for lists
        "next_cursor": "eyJpZCI6...==", // Pass this to ?cursor=... for next page
        "has_more": true,
        "count": 20,
        "limit": 20
      }
    }
    ```
*   **Pagination Logic (Infinite Scroll using TanStack Query)**:
    *   **Endpoint**: `GET /api/v1/leads?limit=20&startDate=YYYY-MM-DD&endDate=YYYY-MM-DD`
    *   **Logic**:
        ```typescript
        useInfiniteQuery({
          queryKey: ['leads'],
          queryFn: ({ pageParam }) => axios.get('/api/v1/leads', { params: { cursor: pageParam, limit: 20 } }),
          getNextPageParam: (lastPage) => lastPage.data.meta.next_cursor ?? undefined,
        })
        ```

### J. Performance & Caching (New)
*   **Compression**: Server sends Gzip/Brotli. Ensure your build tool (Next.js/Vite) supports this (usually automatic).
*   **Conditional Requests (304 Not Modified)**:
    *   The backend supports `ETag`. 
    *   **Browser Behavior**: Browsers automatically handle `If-None-Match` and `304` responses. No manual Axios config needed for basic caching.
    *   **Manual Handling**: If using a custom cache, check `response.status === 304` and use cached data.
*   **Static Data**:
    *   Endpoints like `/api/v1/search` and `/api/v1/analytics` are cached server-side (Memory Cache).
    *   Avoid aggressive polling on these; use SWR/React Query with `staleTime: 60000` (1 min) or `300000` (5 mins).

### K. Search Implementation
*   **Endpoint**: `GET /api/v1/search?q=query`
*   **Algorithm**: The backend now uses a **Weighted Fuzzy Search**.
    *   **Behavior**: Finds Exact matches first, then Prefix matches, then Fuzzy (typo-tolerant) matches (e.g., "admis" finds "Admin").
*   **UI Suggestion**: Debounce the search input by 300-500ms to avoid flooding the API.




### L. Note Object Structure (Updated)
*   **Endpoint**: `POST /api/v1/leads/:id/notes`
*   **Response Payload**:
    ```json
    {
      "note_id": "uuid",
      "content": "Note text...",
      "author_id": "user_uuid",
      "author_name": "John Doe",
      "author_role": "Admission Manager", // [NEW] Context for UI
      "author_email": "john@example.com", // [NEW] Contact info
      "created_at": "04/01/2026 - 09:00:00 am"
    }
    ```
*   **UI Tip**: Display `author_role` next to the name (e.g., "John Doe (Manager)") to give context on who left the note.
### M. Smartflo Integration Details (New)
*   **Initiating a Call (Flow)**:
    1.  Frontend calls `POST /api/v1/leads/:id/call`.
    2.  Backend returns response containing `data.call_id` (or similar ID from Smartflo).
    3.  **CRITICAL**: Frontend MUST store this `call_id` in component state (e.g., `currentCallId`).
*   **Hanging Up**:
    1.  User clicks "Hangup".
    2.  Frontend calls `POST /api/v1/smartflo/hangup` with payload `{ "call_id": currentCallId }`.
    3.  If `call_id` is missing, the API will fail.
*   **Webhooks & Auto-Updates**:
    *   The backend now listens for Smartflo Webhooks.
    *   When a call ends, the backend automatically logs the call details (duration, status, recording) to the Lead's notes/history.
    *   **Frontend Action**: Refetch Lead data (`useQuery` invalidation) 5-10 seconds after a call ends to show the new log.

### N. Postman Payload References (Development & Testing)
For testing via Postman (or Curl), use these JSON payloads.

**1. Simulate Smartflo Webhook (POST /api/v1/smartflo/webhook)**
Use this to test if your backend correctly logs calls to a Lead.
```json
{
    "uuid": "test-uuid-sim-1",
    "call_to_number": "9876543210", 
    "caller_id_number": "08012345678",
    "start_stamp": "2025-01-09 10:00:00",
    "call_id": "sim_call_001",
    "call_status": "answered",
    "direction": "outbound", 
    "duration": "120",
    "recording_url": "http://example.com/rec.mp3",
    "agent_number": "1001", 
    "ref_id": "REPLACE_WITH_LEAD_UUID" 
}
```

**2. Hangup Call (POST /api/v1/smartflo/hangup)**
Use this to test the hangup functionality.
```json
{
    "call_id": "REPLACE_WITH_ACTIVE_CALL_ID" 
}
```
*Note: You must get the `call_id` from the initial `click-to-call` response.*
